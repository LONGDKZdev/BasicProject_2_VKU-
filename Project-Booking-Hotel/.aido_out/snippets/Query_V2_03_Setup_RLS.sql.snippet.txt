// snippet: Query_V2\03_Setup_RLS.sql

-- =========================================
-- 03_SETUP_RLS.SQL
-- =========================================

-- Enable RLS
alter table public.profiles enable row level security;
alter table public.room_types enable row level security;
alter table public.amenities enable row level security;
alter table public.room_type_amenities enable row level security;
alter table public.rooms enable row level security;
alter table public.room_images enable row level security;
alter table public.room_reviews enable row level security;
alter table public.price_rules enable row level security;
alter table public.promotions enable row level security;
alter table public.bookings enable row level security;
alter table public.booking_items enable row level security;
alter table public.audit_logs enable row level security;

-- Policies
create policy "profiles_owner_read" on public.profiles for select using (auth.uid() = id or public.is_admin(auth.uid()));
create policy "profiles_owner_update" on public.profiles for update using (auth.uid() = id or public.is_admin(auth.uid()));

-- PUBLIC READ (Cho phép xem phòng, ảnh, review mà không cần login)
create policy "rt_select_all" on public.room_types for select using (true);
create policy "am_select_all" on public.amenities for select using (true);
create policy "rta_select_all" on public.room_type_amenities for select using (true);
create policy "r_select_all" on public.rooms for select using (true);
create policy "ri_select_all" on public.room_images for select using (true);
create policy "rr_select_all" on public.room_reviews for select using (true);
create policy "pr_select_all" on public.price_rules for select using (true);
create policy "pm_select_all" on public.promotions for select using (true);

-- ADMIN WRITE
create policy "rt_admin_write" on public.room_types for all using (public.is_admin(auth.uid()));
create policy "am_admin_write" on public.amenities for all using (public.is_admin(auth.uid()));
create policy "rta_admin_write" on public.room_type_amenities for all using (public.is_admin(auth.uid()));
create policy "r_admin_write" on public.rooms for all using (public.is_admin(auth.uid()));
create policy "ri_admin_write" on public.room_images for all using (public.is_admin(auth.uid()));
create policy "pr_admin_write" on public.price_rules for all using (public.is_admin(auth.uid()));
create policy "pm_admin_write" on public.promotions for all using (public.is_admin(auth.uid()));