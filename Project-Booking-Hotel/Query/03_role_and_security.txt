-- =========================================
-- 03_ROLE_AND_SECURITY.SQL (FINAL - ENABLED)
-- =========================================

-- Bật RLS
alter table public.profiles enable row level security;
alter table public.room_types enable row level security;
alter table public.amenities enable row level security;
alter table public.room_type_amenities enable row level security;
alter table public.rooms enable row level security;
alter table public.room_images enable row level security;
alter table public.room_reviews enable row level security;
alter table public.price_rules enable row level security;
alter table public.promotions enable row level security;
alter table public.bookings enable row level security;
alter table public.booking_items enable row level security;
alter table public.restaurant_bookings enable row level security; -- NEW
alter table public.spa_bookings enable row level security; -- NEW
alter table public.holiday_calendar enable row level security; -- NEW
alter table public.audit_logs enable row level security;


-- PROFILES: chỉ chủ sở hữu xem/sửa; admin xem tất cả
create policy "profiles_owner_read" on public.profiles
for select using (
  auth.uid() = id or public.is_admin(auth.uid())
);
create policy "profiles_owner_update" on public.profiles
for update using (
 auth.uid() = id or public.is_admin(auth.uid())
);

-- ROOM TYPES, AMENITIES, ROOMS, IMAGES: ai cũng xem; admin mới tạo/sửa/xóa
create policy "rt_select_all" on public.room_types for select using (true);
create policy "am_select_all" on public.amenities for select using (true);
create policy "rta_select_all" on public.room_type_amenities for select using (true);
create policy "r_select_all" on public.rooms for select using (true);
create policy "ri_select_all" on public.room_images for select using (true);

create policy "rt_admin_write" on public.room_types for all using (public.is_admin(auth.uid()));
create policy "am_admin_write" on public.amenities for all using (public.is_admin(auth.uid()));
create policy "rta_admin_write" on public.room_type_amenities for all using (public.is_admin(auth.uid()));
create policy "r_admin_write" on public.rooms for all using (public.is_admin(auth.uid()));
create policy "ri_admin_write" on public.room_images for all using (public.is_admin(auth.uid()));

-- ROOM REVIEWS: ai cũng xem; user tạo review của họ; admin quản trị
create policy "rr_select_all" on public.room_reviews for select using (true);
create policy "rr_user_insert" on public.room_reviews for insert with check (auth.uid() = user_id or user_id is null);
create policy "rr_user_update" on public.room_reviews for update using (auth.uid() = user_id or public.is_admin(auth.uid()));
create policy "rr_admin_delete" on public.room_reviews for delete using (public.is_admin(auth.uid()));

-- PRICE RULES & PROMOTIONS: public đọc; admin quản trị
create policy "pr_select_all" on public.price_rules for select using (true);
create policy "pr_admin_write" on public.price_rules for all using (public.is_admin(auth.uid()));

create policy "pm_select_all" on public.promotions for select using (true);
create policy "pm_admin_write" on public.promotions for all using (public.is_admin(auth.uid()));

-- HOLIDAY CALENDAR: public đọc; admin quản trị (NEW)
create policy "hc_select_all" on public.holiday_calendar for select using (true);
create policy "hc_admin_write" on public.holiday_calendar for all using (public.is_admin(auth.uid()));

-- ROOM BOOKINGS: chủ sở hữu xem + tạo; admin xem tất cả
create policy "b_owner_read" on public.bookings
for select using (auth.uid() = user_id or public.is_admin(auth.uid()));
create policy "b_owner_insert" on public.bookings
for insert with check (auth.uid() = user_id or public.is_admin(auth.uid()));
create policy "b_owner_update" on public.bookings
for update using (auth.uid() = user_id or public.is_admin(auth.uid()));

-- RESTAURANT BOOKINGS: chủ sở hữu xem + tạo; admin xem tất cả (NEW)
create policy "rb_owner_read" on public.restaurant_bookings
for select using (auth.uid() = user_id or public.is_admin(auth.uid()));
create policy "rb_owner_insert" on public.restaurant_bookings
for insert with check (auth.uid() = user_id or public.is_admin(auth.uid()));
create policy "rb_owner_update" on public.restaurant_bookings
for update using (auth.uid() = user_id or public.is_admin(auth.uid()));

-- SPA BOOKINGS: chủ sở hữu xem + tạo; admin xem tất cả (NEW)
create policy "sb_owner_read" on public.spa_bookings
for select using (auth.uid() = user_id or public.is_admin(auth.uid()));
create policy "sb_owner_insert" on public.spa_bookings
for insert with check (auth.uid() = user_id or public.is_admin(auth.uid()));
create policy "sb_owner_update" on public.spa_bookings
for update using (auth.uid() = user_id or public.is_admin(auth.uid()));

-- BOOKING ITEMS: ràng theo booking cha
create policy "bi_read" on public.booking_items
for select using (
 exists(select 1 from public.bookings b where b.id = booking_items.booking_id and (b.user_id = auth.uid() or public.is_admin(auth.uid())))
);
create policy "bi_write" on public.booking_items
for all using (
 exists(select 1 from public.bookings b where b.id = booking_items.booking_id and (b.user_id = auth.uid() or public.is_admin(auth.uid())))
);

-- AUDIT LOGS: chỉ admin
create policy "audit_admin_read" on public.audit_logs for select using (public.is_admin(auth.uid()));
create policy "audit_admin_write" on public.audit_logs for all using (public.is_admin(auth.uid()));