-- =====================================================
-- 08_COMPLETE_SCHEMA_AUDIT.SQL
-- =====================================================
-- Rà lại toàn bộ schema và đồng bộ dữ liệu
-- Chạy file này để verify tất cả bảng và dữ liệu

-- ========== 1. VERIFY TABLES EXIST ==========
SELECT 
  tablename,
  (SELECT count(*) FROM information_schema.columns WHERE table_name = tablename) as column_count
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY tablename;

-- ========== 2. CHECK ROOM TYPES ==========
SELECT 'ROOM TYPES' as check_name, count(*) as total, 
  sum(case when is_active = true then 1 else 0 end) as active,
  sum(case when is_active = false then 1 else 0 end) as inactive
FROM public.room_types;

-- ========== 3. CHECK ROOMS ==========
SELECT 'ROOMS' as check_name, count(*) as total,
  sum(case when status = 'available' then 1 else 0 end) as available,
  sum(case when status = 'occupied' then 1 else 0 end) as occupied,
  sum(case when status = 'maintenance' then 1 else 0 end) as maintenance,
  sum(case when status = 'cleaning' then 1 else 0 end) as cleaning
FROM public.rooms;

-- ========== 4. CHECK AMENITIES ==========
SELECT 'AMENITIES' as check_name, count(*) as total
FROM public.amenities;

-- ========== 5. CHECK ROOM REVIEWS ==========
SELECT 'ROOM REVIEWS' as check_name, count(*) as total,
  round(avg(rating)::numeric, 2) as avg_rating,
  min(rating) as min_rating,
  max(rating) as max_rating
FROM public.room_reviews;

-- ========== 6. CHECK PRICE RULES ==========
SELECT 'PRICE RULES' as check_name, count(*) as total,
  sum(case when is_active = true then 1 else 0 end) as active
FROM public.price_rules;

-- ========== 7. CHECK PROMOTIONS ==========
SELECT 'PROMOTIONS' as check_name, count(*) as total,
  sum(case when is_active = true then 1 else 0 end) as active
FROM public.promotions;

-- ========== 8. CHECK ROOM IMAGES ==========
SELECT 'ROOM IMAGES' as check_name, count(*) as total
FROM public.room_images;

-- ========== 9. DETAILED ROOM TYPES INFO ==========
SELECT 
  id,
  code,
  name,
  base_price,
  max_person,
  is_active,
  array_length(facilities, 1) as facility_count,
  created_at
FROM public.room_types
ORDER BY code;

-- ========== 10. DETAILED ROOMS INFO ==========
SELECT 
  r.id,
  r.room_no,
  r.name,
  r.category,
  r.price,
  r.status,
  rt.name as room_type_name,
  rt.is_active as room_type_active
FROM public.rooms r
LEFT JOIN public.room_types rt ON r.room_type_id = rt.id
ORDER BY r.room_no
LIMIT 10;

-- ========== 11. CHECK RLS POLICIES ==========
SELECT 
  tablename,
  policyname,
  permissive,
  roles,
  qual as policy_condition
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;

-- ========== 12. VERIFY FOREIGN KEY RELATIONSHIPS ==========
SELECT 
  constraint_name,
  table_name,
  column_name,
  referenced_table_name,
  referenced_column_name
FROM information_schema.referential_constraints
WHERE constraint_schema = 'public'
ORDER BY table_name;

-- ========== 13. CHECK DATA CONSISTENCY ==========
-- Rooms without valid room_type
SELECT COUNT(*) as orphaned_rooms
FROM public.rooms
WHERE room_type_id NOT IN (SELECT id FROM public.room_types);

-- Room reviews without valid room_type
SELECT COUNT(*) as orphaned_reviews
FROM public.room_reviews
WHERE room_type_id NOT IN (SELECT id FROM public.room_types);

-- Price rules without valid room_type
SELECT COUNT(*) as orphaned_price_rules
FROM public.price_rules
WHERE room_type_id IS NOT NULL 
  AND room_type_id NOT IN (SELECT id FROM public.room_types);

-- ========== 14. SUMMARY REPORT ==========
SELECT 
  'Room Types' as entity,
  COUNT(*) as count,
  COUNT(CASE WHEN is_active THEN 1 END) as active
FROM public.room_types
UNION ALL
SELECT 'Rooms', COUNT(*), COUNT(CASE WHEN status = 'available' THEN 1 END)
FROM public.rooms
UNION ALL
SELECT 'Amenities', COUNT(*), COUNT(*)
FROM public.amenities
UNION ALL
SELECT 'Reviews', COUNT(*), COUNT(CASE WHEN rating >= 4 THEN 1 END)
FROM public.room_reviews
UNION ALL
SELECT 'Price Rules', COUNT(*), COUNT(CASE WHEN is_active THEN 1 END)
FROM public.price_rules
UNION ALL
SELECT 'Promotions', COUNT(*), COUNT(CASE WHEN is_active THEN 1 END)
FROM public.promotions;

-- ========== 15. EXPECTED VALUES ==========
-- Nếu tất cả dữ liệu được populate đúng, bạn sẽ thấy:
-- Room Types: 5 (STD, DLX, SUI, PEN, CMB) - tất cả active
-- Rooms: 40 (8 per type) - tất cả available
-- Amenities: 8 (Wifi, Coffee, Bath, Parking Space, Swimming Pool, Breakfast, GYM, Drinks)
-- Reviews: 20 (4 per room type)
-- Price Rules: 5 (1 per room type)
-- Promotions: 3 (WELCOME25, SUMMER50, WEEKEND15)
