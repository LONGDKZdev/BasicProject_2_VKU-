-- =====================================
-- 01_CREATE_SCHEMA_TABLES_UPDATED.SQL
-- =====================================
-- Updated schema based on actual frontend data structure from src/db/data.js
-- Support for room properties: id, name, type, category, size, maxPerson, price, image, imageLg, description, facilities, reviews

-- ====== EXTENSIONS ======
create extension if not exists "pgcrypto";

-- ====== ENUMS ======
do $$
begin
  if not exists (select 1 from pg_type where typname = 'room_status') then
    create type room_status as enum ('available', 'occupied', 'maintenance', 'cleaning');
  end if;
  if not exists (select 1 from pg_type where typname = 'booking_status') then
    create type booking_status as enum (
      'pending',
      'pending_payment',
      'approved',
      'rejected',
      'confirmed',
      'checked_in',
      'checked_out',
      'modified',
      'completed',
      'cancelled'
    );
  end if;
  if not exists (select 1 from pg_type where typname = 'price_rule_type') then
    create type price_rule_type as enum ('weekend', 'holiday', 'seasonal', 'season');
  end if;
  if not exists (select 1 from pg_type where typname = 'discount_type') then
    create type discount_type as enum ('percent', 'fixed');
  end if;
end$$;

-- ====== HELPER FUNCTION (auto updated_at) ======
create or replace function public.trigger_set_timestamp()
returns trigger language plpgsql as $$
begin
  new.updated_at = now();
  return new;
end$$;

-- ====== PROFILES (map với Supabase Auth) ======
create table if not exists public.profiles (
  id uuid primary key default gen_random_uuid(),
  full_name text,
  phone text,
  avatar_url text,
  country text,
  city text,
  preferences jsonb not null default '[]'::jsonb,
  language text not null default 'en',
  newsletter boolean not null default true,
  bio text,
  role text not null default 'user', -- user / admin
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);
drop trigger if exists set_profiles_updated_at on public.profiles;
create trigger set_profiles_updated_at
before update on public.profiles
for each row execute procedure public.trigger_set_timestamp();

-- Trigger cho user mới
create or replace function public.handle_new_user()
returns trigger language plpgsql security definer as $$
begin
  insert into public.profiles (id, full_name, role)
  values (new.id, coalesce(new.raw_user_meta_data->>'full_name',''), 'user');
  return new;
end$$;
drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- Helper check admin
create or replace function public.is_admin(uid uuid)
returns boolean language sql stable as $$
  select exists(
    select 1 from public.profiles p where p.id = uid and p.role = 'admin'
  );
$$;

-- ====== AMENITIES (Tiện nghi / Facilities) ======
create table if not exists public.amenities (
  id uuid primary key default gen_random_uuid(),
  name text unique not null,
  icon_name text, -- e.g., "FaWifi", "FaCoffee"
  created_at timestamptz not null default now()
);

-- ====== ROOM TYPES (Loại phòng - Category) ======
-- Maps to src/db/data.js: roomCategories with ids: standard, deluxe, suite, penthouse, combo
create table if not exists public.room_types (
  id uuid primary key default gen_random_uuid(),
  code text unique not null, -- standard, deluxe, suite, penthouse, combo
  name text not null,
  description text,
  base_capacity int not null default 2,
  max_person int not null default 2,
  base_price numeric(12,2) not null,
  is_active boolean not null default true,
  
  -- Frontend-compatible fields
  facilities text[] default '{}', -- Array of facility names: ["Wifi", "Coffee", "Bath", ...]
  hotel_rules text[] default '{}',
  cancellation_policy text,
  
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint chk_room_types_capacity check (max_person >= base_capacity)
);
drop trigger if exists set_room_types_updated_at on public.room_types;
create trigger set_room_types_updated_at
before update on public.room_types
for each row execute procedure public.trigger_set_timestamp();

-- ====== ROOM TYPE AMENITIES (Bảng nối) ======
create table if not exists public.room_type_amenities (
  room_type_id uuid not null references public.room_types(id) on delete cascade,
  amenity_id uuid not null references public.amenities(id) on delete cascade,
  primary key (room_type_id, amenity_id)
);

-- ====== ROOM IMAGES (Ảnh cho từng phòng) ======
create table if not exists public.room_images (
  id uuid primary key default gen_random_uuid(),
  room_type_id uuid not null references public.room_types(id) on delete cascade,
  image_url text not null,
  image_lg_url text, -- Large version
  display_order int default 0,
  created_at timestamptz not null default now()
);
create index if not exists idx_room_images_room_type_id on public.room_images(room_type_id);

-- ====== ROOMS (Phòng - Physical instances) ======
-- Maps to src/db/data.js: roomData with properties (name, type, category, size, maxPerson, price, etc.)
create table if not exists public.rooms (
  id uuid primary key default gen_random_uuid(),
  
  -- Basic info (from roomData)
  room_no text unique not null, -- e.g., "STD-01", "DLX-01"
  name text not null, -- e.g., "Standard Room", "Cozy Studio Standard"
  room_type_id uuid not null references public.room_types(id),
  
  -- Physical properties
  floor int,
  size int, -- m2 (from src: 28-90)
  
  -- Status & Management
  status room_status not null default 'available',
  
  -- Frontend-compatible cached fields
  type text, -- e.g., "Standard", "Deluxe" (cached from room_type)
  category text, -- e.g., "standard", "deluxe" (cached from room_type.code)
  price numeric(12,2), -- Current price (can override room_type.base_price)
  description text,
  
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);
create index if not exists idx_rooms_room_type_id on public.rooms(room_type_id);
create index if not exists idx_rooms_category on public.rooms(category);
drop trigger if exists set_rooms_updated_at on public.rooms;
create trigger set_rooms_updated_at
before update on public.rooms
for each row execute procedure public.trigger_set_timestamp();

-- ====== PRICE RULES (Quy tắc giá) ======
create table if not exists public.price_rules (
  id uuid primary key default gen_random_uuid(),
  rule_type price_rule_type not null, -- weekend, holiday, seasonal, season
  room_type_id uuid references public.room_types(id) on delete cascade,
  
  -- Date range (optional, for seasonal pricing)
  start_date date,
  end_date date,
  description text,
  
  -- Day of week (for recurring rules like weekend)
  apply_fri boolean not null default false,
  apply_sat boolean not null default false,
  apply_sun boolean not null default false,
  
  -- Multiplier (1.15 = 15% increase) or absolute price
  price numeric(12,2) not null,
  
  priority int not null default 10, -- Lower = higher priority
  is_active boolean not null default true,
  
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint chk_price_rule_dates check (
    end_date is null or start_date is null or end_date >= start_date
  )
);
create index if not exists idx_price_rules_room_type_id on public.price_rules(room_type_id);
drop trigger if exists set_price_rules_updated_at on public.price_rules;
create trigger set_price_rules_updated_at
before update on public.price_rules
for each row execute procedure public.trigger_set_timestamp();

-- ====== PROMOTIONS (Khuyến mãi) ======
create table if not exists public.promotions (
  id uuid primary key default gen_random_uuid(),
  code text unique not null,
  name text not null,
  description text,
  discount_kind discount_type not null, -- percent or fixed
  discount_value numeric(12,2) not null,
  start_date date not null,
  end_date date not null,
  is_active boolean not null default true,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint chk_promo_dates check (end_date >= start_date)
);

-- ====== BOOKINGS (Đơn đặt phòng) ======
-- Maps to src/context/RoomContext.jsx booking object
create table if not exists public.bookings (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id),
  
  -- Confirmation & Status
  confirmation_code text not null unique,
  booking_type text not null default 'room', -- room, restaurant, spa
  status booking_status not null default 'pending_payment',
  
  -- Dates
  check_in date not null,
  check_out date not null,
  
  -- Room reference
  room_id uuid references public.rooms(id),
  room_name text,
  
  -- Guest info
  user_name text,
  user_email text,
  guest_name text,
  guest_phone text,
  note text,
  
  -- Promo (if any)
  promo_code text references public.promotions(code),
  
  -- Frontend-compatible fields
  num_adults int not null default 1,
  num_children int not null default 0,
  total_nights int not null default 1,
  
  -- Pricing
  subtotal numeric(12,2) not null default 0,
  discount numeric(12,2) not null default 0,
  total_amount numeric(12,2) not null default 0,
  
  -- Complex data (stored as JSON)
  pricing_breakdown jsonb not null default '[]'::jsonb, -- Array of {date, label, rate}
  history jsonb not null default '[]'::jsonb, -- Booking change history
  
  -- Payment
  payment_code text,
  payment_method text,
  paid_at timestamptz,
  
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  
  constraint chk_dates_valid check (check_out > check_in),
  constraint chk_guests_positive check (num_adults >= 0 and num_children >= 0)
);
create index if not exists idx_bookings_user_id on public.bookings(user_id);
create index if not exists idx_bookings_dates on public.bookings(check_in, check_out);
create unique index if not exists idx_bookings_confirmation_code on public.bookings(confirmation_code);
create index if not exists idx_bookings_status on public.bookings(status);
create index if not exists idx_bookings_paid_at on public.bookings(paid_at);
drop trigger if exists set_bookings_updated_at on public.bookings;
create trigger set_bookings_updated_at
before update on public.bookings
for each row execute procedure public.trigger_set_timestamp();

-- ====== BOOKING ITEMS (Chi tiết đơn đặt phòng) ======
create table if not exists public.booking_items (
  id uuid primary key default gen_random_uuid(),
  booking_id uuid not null references public.bookings(id) on delete cascade,
  room_id uuid not null references public.rooms(id),
  room_type_id uuid not null references public.room_types(id),
  price_per_night numeric(12,2) not null,
  nights int not null,
  amount numeric(12,2) not null,
  created_at timestamptz not null default now()
);
create index if not exists idx_booking_items_booking_id on public.booking_items(booking_id);
create index if not exists idx_booking_items_room_id on public.booking_items(room_id);

-- ====== ROOM REVIEWS (Đánh giá phòng) ======
-- Maps to src/db/data.js defaultReview and reviews array
create table if not exists public.room_reviews (
  id uuid primary key default gen_random_uuid(),
  room_type_id uuid not null references public.room_types(id) on delete cascade,
  booking_id uuid references public.bookings(id) on delete set null,
  user_id uuid references auth.users(id),
  
  user_name text,
  user_email text,
  rating int not null check (rating between 1 and 5),
  comment text,
  stay_date date, -- When the guest stayed (e.g., "Oct 2024")
  
  created_at timestamptz not null default now()
);
create index if not exists idx_room_reviews_room_type_id on public.room_reviews(room_type_id);
create index if not exists idx_room_reviews_user_id on public.room_reviews(user_id);

-- ====== BOOKING PRICING BREAKDOWN (Optional, for detailed tracking) ======
create table if not exists public.booking_pricing_breakdown (
  id bigint generated by default as identity primary key,
  booking_id uuid not null references public.bookings(id) on delete cascade,
  stay_date date not null,
  rate_type text not null, -- weekday, weekend, holiday
  rate numeric(12,2) not null,
  created_at timestamptz not null default now(),
  constraint uniq_booking_pricing unique (booking_id, stay_date, rate_type)
);
create index if not exists idx_booking_pricing_booking_id on public.booking_pricing_breakdown(booking_id);

-- ====== BOOKING EVENTS (History/Audit) ======
create table if not exists public.booking_events (
  id bigint generated by default as identity primary key,
  booking_id uuid not null references public.bookings(id) on delete cascade,
  event_type text not null, -- cancel, modify, confirm, check_in, check_out
  note text,
  actor uuid references auth.users(id),
  meta jsonb,
  created_at timestamptz not null default now()
);
create index if not exists idx_booking_events_booking_id on public.booking_events(booking_id);

-- ====== RESTAURANT BOOKINGS ======
create table if not exists public.restaurant_bookings (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id),
  confirmation_code text not null unique,
  name text not null,
  email text not null,
  phone text,
  reservation_at timestamptz not null,
  guests int not null default 1,
  special_requests text,
  price numeric(12,2) not null default 0,
  total_price numeric(12,2) not null default 0,
  status booking_status not null default 'pending_payment',
  payment_code text,
  payment_method text,
  paid_at timestamptz,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint chk_restaurant_guests check (guests > 0),
  constraint chk_restaurant_price_nonnegative check (price >= 0 and total_price >= 0)
);
create index if not exists idx_restaurant_bookings_user_id on public.restaurant_bookings(user_id);
create index if not exists idx_restaurant_bookings_status on public.restaurant_bookings(status);
create index if not exists idx_restaurant_bookings_reservation_at on public.restaurant_bookings(reservation_at);
drop trigger if exists set_restaurant_bookings_updated_at on public.restaurant_bookings;
create trigger set_restaurant_bookings_updated_at
before update on public.restaurant_bookings
for each row execute procedure public.trigger_set_timestamp();

-- ====== SPA BOOKINGS ======
create table if not exists public.spa_bookings (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id),
  confirmation_code text not null unique,
  name text not null,
  email text not null,
  phone text,
  appointment_at timestamptz not null,
  service_name text not null,
  service_duration text,
  therapist text,
  special_requests text,
  price numeric(12,2) not null default 0,
  total_price numeric(12,2) not null default 0,
  status booking_status not null default 'pending_payment',
  payment_code text,
  payment_method text,
  paid_at timestamptz,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint chk_spa_price_nonnegative check (price >= 0 and total_price >= 0)
);
create index if not exists idx_spa_bookings_user_id on public.spa_bookings(user_id);
create index if not exists idx_spa_bookings_status on public.spa_bookings(status);
create index if not exists idx_spa_bookings_appointment_at on public.spa_bookings(appointment_at);
drop trigger if exists set_spa_bookings_updated_at on public.spa_bookings;
create trigger set_spa_bookings_updated_at
before update on public.spa_bookings
for each row execute procedure public.trigger_set_timestamp();

-- ====== PASSWORD RESET REQUESTS ======
create table if not exists public.password_reset_requests (
  id uuid primary key default gen_random_uuid(),
  email text not null,
  code text not null,
  expires_at timestamptz not null,
  used_at timestamptz,
  created_at timestamptz not null default now()
);
create index if not exists idx_password_reset_email on public.password_reset_requests(email);
create unique index if not exists idx_password_reset_email_active
  on public.password_reset_requests(email)
  where used_at is null;

-- ====== LOGS (Nhật ký hoạt động) ======
create table if not exists public.audit_logs (
  id bigint generated by default as identity primary key,
  actor uuid references auth.users(id),
  action text not null,
  target_table text,
  target_id text,
  meta jsonb,
  created_at timestamptz not null default now()
);
create index if not exists idx_audit_logs_actor on public.audit_logs(actor);

-- ====== HOLIDAY CALENDAR (Lịch ngày lễ) ======
create table if not exists public.holiday_calendar (
  id uuid primary key default gen_random_uuid(),
  holiday_date date not null unique,
  name text, -- e.g., "New Year", "Christmas"
  multiplier numeric(5,2) default 1.35, -- Price multiplier for this day
  is_active boolean not null default true,
  created_at timestamptz not null default now()
);
create index if not exists idx_holiday_calendar_date on public.holiday_calendar(holiday_date);